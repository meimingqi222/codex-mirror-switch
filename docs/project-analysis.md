# Codex Mirror Switch é¡¹ç›®åˆ†ææŠ¥å‘Š

> åˆ†ææ—¥æœŸ: 2024-11
> åˆ†æèŒƒå›´: ä»£ç è´¨é‡ã€æ½œåœ¨Bugã€ç¼ºå¤±åŠŸèƒ½ã€ä¼˜åŒ–å»ºè®®

---

## ğŸ‰ å·²ä¿®å¤é—®é¢˜ (2024-11)

ä»¥ä¸‹é—®é¢˜å·²åœ¨æœ¬æ¬¡æ›´æ–°ä¸­ä¿®å¤ï¼š

| é—®é¢˜ | ä¿®å¤æ–‡ä»¶ | çŠ¶æ€ |
|------|----------|------|
| `--codex-only` æ ‡å¿—æœªä½¿ç”¨ | `cmd/switch.go` | âœ… å·²ä¿®å¤ |
| VS Code é…ç½®éåŸå­å†™å…¥ | `internal/vscode.go` | âœ… å·²ä¿®å¤ |
| Windows ç¯å¢ƒå˜é‡åˆ é™¤æ–¹å¼é”™è¯¯ | `internal/env.go` | âœ… å·²ä¿®å¤ |
| ç¼ºå°‘ URL æ ¼å¼éªŒè¯ | `internal/mirror.go`, `cmd/add.go` | âœ… å·²æ·»åŠ  |
| ç¼ºå°‘ `update` å‘½ä»¤ | `cmd/update.go` | âœ… å·²æ·»åŠ  |
| ç¼ºå°‘ `version` å‘½ä»¤ | `cmd/version.go` | âœ… å·²æ·»åŠ  |
| é”™è¯¯å¤„ç†é£æ ¼ä¸ç»Ÿä¸€ | `cmd/status.go`, `cmd/list.go` | âœ… å·²ä¿®å¤ |

### æ–°å¢å‘½ä»¤ç”¨æ³•

**update å‘½ä»¤**:
```bash
codex-mirror update myapi --url https://new-api.example.com
codex-mirror update myapi --key sk-new-key
codex-mirror update myclaude --model claude-3-5-sonnet-20241022
codex-mirror update myapi --type claude
```

**version å‘½ä»¤**:
```bash
codex-mirror version          # æ˜¾ç¤ºå®Œæ•´ç‰ˆæœ¬ä¿¡æ¯
codex-mirror version --short  # åªæ˜¾ç¤ºç‰ˆæœ¬å·
```

---

## ä¸€ã€æ½œåœ¨ Bug å’Œé—®é¢˜

### 1. ğŸ”´ ä¸¥é‡é—®é¢˜

#### 1.1 `switch.go` ä¸­ `codexOnly` æ ‡å¿—æœªä½¿ç”¨
```go
// cmd/switch.go:12-18
var (
    codexOnly  bool  // å·²å£°æ˜ä½†åœ¨ applyCodexConfig ä¸­æœªä½¿ç”¨
    vscodeOnly bool
    ...
)
```
- **é—®é¢˜**: `--codex-only` æ ‡å¿—å·²å®šä¹‰ä½†é€»è¾‘æœªå®ç°ï¼Œç”¨æˆ·ä½¿ç”¨æ­¤æ ‡å¿—ä¸ä¼šæœ‰ä»»ä½•æ•ˆæœ
- **å»ºè®®**: åœ¨ `applyCodexConfig()` ä¸­æ·»åŠ æ¡ä»¶åˆ¤æ–­ï¼Œæˆ–ç§»é™¤è¯¥æ ‡å¿—

#### 1.2 `vscode.go` SaveSettings ä¸æ˜¯åŸå­å†™å…¥
```go
// internal/vscode.go:60-78
func (vcm *VSCodeConfigManager) SaveSettings(settings map[string]interface{}) error {
    file, err := os.Create(vcm.settingsPath)  // ç›´æ¥åˆ›å»ºï¼ŒéåŸå­æ“ä½œ
    ...
}
```
- **é—®é¢˜**: ä¸ `mirror.go`ã€`codex.go` ä¸­ä½¿ç”¨ä¸´æ—¶æ–‡ä»¶+é‡å‘½åçš„åŸå­å†™å…¥æ–¹å¼ä¸ä¸€è‡´ï¼Œå¯èƒ½å¯¼è‡´å†™å…¥ä¸­æ–­æ—¶é…ç½®æ–‡ä»¶æŸå
- **å»ºè®®**: ç»Ÿä¸€ä½¿ç”¨åŸå­å†™å…¥æ¨¡å¼

#### 1.3 é”™è¯¯å¤„ç†ä¸ä¸€è‡´
```go
// cmd/status.go:27-29
if err != nil {
    fmt.Fprintf(os.Stderr, "é”™è¯¯: %v\n", err)
    os.Exit(1)
    return  // ä¸å¯è¾¾ä»£ç 
}
```
- **é—®é¢˜**: éƒ¨åˆ†å‘½ä»¤ä½¿ç”¨ `os.Exit(1)` ç›´æ¥é€€å‡ºï¼Œéƒ¨åˆ†ä½¿ç”¨ `return fmt.Errorf()`ï¼Œé£æ ¼ä¸ç»Ÿä¸€
- **å»ºè®®**: ç»Ÿä¸€ä½¿ç”¨ `RunE` + `return error` æ¨¡å¼ï¼Œè®© Cobra å¤„ç†é€€å‡ºç 

### 2. ğŸŸ¡ ä¸­ç­‰é—®é¢˜

#### 2.1 Windows ç¯å¢ƒå˜é‡æ¸…é™¤æ–¹å¼æœ‰é—®é¢˜
```go
// internal/env.go:276-283
cmd := exec.Command("setx", envKey, "")  // setx è®¾ç½®ç©ºå­—ç¬¦ä¸²ä¸ç­‰äºåˆ é™¤
```
- **é—®é¢˜**: `setx VAR ""` ä¼šå°†å˜é‡è®¾ç½®ä¸ºç©ºå­—ç¬¦ä¸²ï¼Œè€ŒéçœŸæ­£åˆ é™¤ï¼Œåº”ä½¿ç”¨æ³¨å†Œè¡¨æ“ä½œæˆ– `reg delete`
- **å»ºè®®**: ä½¿ç”¨ `reg delete "HKCU\Environment" /v VAR /f` æ¥çœŸæ­£åˆ é™¤ç¯å¢ƒå˜é‡

#### 2.2 ç¼ºå°‘ URL éªŒè¯
```go
// cmd/add.go:37-43
baseURL := args[1]  // æœªéªŒè¯ URL æ ¼å¼
```
- **é—®é¢˜**: æ·»åŠ é•œåƒæºæ—¶ä¸éªŒè¯ URL æ ¼å¼ï¼Œå¯èƒ½å¯¼è‡´æ— æ•ˆé…ç½®
- **å»ºè®®**: æ·»åŠ  URL æ ¼å¼éªŒè¯ï¼Œè‡³å°‘æ£€æŸ¥ scheme å’Œ host

#### 2.3 API Key æ•æ„Ÿä¿¡æ¯å¯èƒ½æ³„éœ²åˆ°æ—¥å¿—
```go
// internal/mirror.go:480-483
if err := mm.saveConfig(); err != nil {
    fmt.Printf("ä¿å­˜é…ç½®å¤±è´¥: %v\n", err)  // é”™è¯¯ä¿¡æ¯å¯èƒ½åŒ…å«æ•æ„Ÿè·¯å¾„
}
```
- **é—®é¢˜**: éƒ¨åˆ†é”™è¯¯è¾“å‡ºå¯èƒ½åŒ…å«æ•æ„Ÿä¿¡æ¯ï¼Œåº”åŒºåˆ† debug å’Œ production æ¨¡å¼

### 3. ğŸŸ¢ è½»å¾®é—®é¢˜

#### 3.1 æµ‹è¯•å¸¸é‡æš´éœ²åœ¨ types.go ä¸­
```go
// internal/types.go:6-13
const (
    TestAPIURL       = "https://api.test.com"
    TestProviderName = "test-provider"
    ...
)
```
- **é—®é¢˜**: æµ‹è¯•ä¸“ç”¨å¸¸é‡ä¸åº”æ”¾åœ¨ç”Ÿäº§ä»£ç ä¸­
- **å»ºè®®**: ç§»åŠ¨åˆ° `internal/testutil_test.go` æˆ–å•ç‹¬çš„æµ‹è¯•åŒ…ä¸­

#### 3.2 ç¡¬ç¼–ç çš„æ¨¡å‹åç§°
```go
// internal/vscode.go:101-103
chatgptConfig["model"] = TestModelGPT5  // "gpt-5"
chatgptConfig["model_reasoning_effort"] = TestHighEffort  // "high"
```
- **é—®é¢˜**: VS Code é…ç½®ä¸­ç¡¬ç¼–ç äº†æ¨¡å‹åç§°ï¼Œåº”ä»é•œåƒé…ç½®ä¸­è¯»å–
- **å»ºè®®**: ä½¿ç”¨ `mirror.ModelName` æˆ–æä¾›é»˜è®¤å€¼é…ç½®

---

## äºŒã€ç¼ºå¤±åŠŸèƒ½

### 1. ğŸ”´ å…³é”®ç¼ºå¤±

#### 1.1 ç¼ºå°‘ `update` å‘½ä»¤
- å½“å‰åªèƒ½é€šè¿‡åˆ é™¤+é‡æ–°æ·»åŠ æ¥æ›´æ–°é•œåƒæºé…ç½®
- **å»ºè®®**: æ·»åŠ  `codex-mirror update <name> [--url] [--key] [--model]` å‘½ä»¤

#### 1.2 ç¼ºå°‘é…ç½®å¯¼å…¥/å¯¼å‡ºåŠŸèƒ½
- é™¤äº‘åŒæ­¥å¤–ï¼Œæ²¡æœ‰æœ¬åœ°æ–‡ä»¶å¯¼å…¥å¯¼å‡ºèƒ½åŠ›
- **å»ºè®®**: æ·»åŠ  `codex-mirror export/import` å‘½ä»¤æ”¯æŒ JSON/YAML æ ¼å¼

#### 1.3 ç¼ºå°‘é…ç½®éªŒè¯å‘½ä»¤
- åˆ‡æ¢é…ç½®åæ— æ³•éªŒè¯è¿æ¥æ˜¯å¦æ­£å¸¸
- **å»ºè®®**: æ·»åŠ  `codex-mirror test <name>` å‘½ä»¤ï¼Œå‘ API å‘é€æµ‹è¯•è¯·æ±‚

### 2. ğŸŸ¡ å»ºè®®æ·»åŠ 

#### 2.1 ç¼ºå°‘ç‰ˆæœ¬ä¿¡æ¯å‘½ä»¤
```go
// å½“å‰æ²¡æœ‰ version å‘½ä»¤
```
- **å»ºè®®**: æ·»åŠ  `codex-mirror version` æ˜¾ç¤ºç‰ˆæœ¬ã€æ„å»ºæ—¶é—´ã€Git commit ç­‰ä¿¡æ¯

#### 2.2 ç¼ºå°‘è‡ªåŠ¨è¡¥å…¨æ”¯æŒ
- **å»ºè®®**: æ·»åŠ  `codex-mirror completion [bash|zsh|fish|powershell]` ç”Ÿæˆ shell è¡¥å…¨è„šæœ¬

#### 2.3 ç¼ºå°‘é…ç½®æ–‡ä»¶ä½ç½®æ˜¾ç¤º
- **å»ºè®®**: `codex-mirror status` ä¸­æ˜¾ç¤ºæ‰€æœ‰é…ç½®æ–‡ä»¶çš„å®é™…è·¯å¾„

#### 2.4 ç¼ºå°‘æ—¥å¿—çº§åˆ«æ§åˆ¶
- **å»ºè®®**: æ·»åŠ  `--verbose` æˆ– `--debug` å…¨å±€æ ‡å¿—æ§åˆ¶è¾“å‡ºè¯¦ç»†ç¨‹åº¦

### 3. ğŸŸ¢ å¯é€‰å¢å¼º

#### 3.1 æ”¯æŒé…ç½®æ–‡ä»¶çƒ­é‡è½½
- ç›‘å¬é…ç½®æ–‡ä»¶å˜åŒ–ï¼Œè‡ªåŠ¨åº”ç”¨æ–°é…ç½®

#### 3.2 æ”¯æŒé…ç½®æ–‡ä»¶æ³¨é‡Š
- å½“å‰ TOML é…ç½®ä¸ä¿ç•™ç”¨æˆ·æ³¨é‡Š

#### 3.3 æ”¯æŒå¤šä¸ª VS Code å˜ä½“
- å½“å‰åªæ”¯æŒæ ‡å‡† VS Codeï¼Œä¸æ”¯æŒ VSCodiumã€Code Insiders ç­‰

---

## ä¸‰ã€ä»£ç ä¼˜åŒ–å»ºè®®

### 1. æ¶æ„ä¼˜åŒ–

#### 1.1 å¼•å…¥æ¥å£æŠ½è±¡
```go
// å»ºè®®æ·»åŠ  ConfigManager æ¥å£
type ConfigManager interface {
    Load() error
    Save() error
    Backup() error
    GetPath() string
}
```
- ä½¿ `CodexConfigManager`, `VSCodeConfigManager`, `MirrorManager` å®ç°ç»Ÿä¸€æ¥å£

#### 1.2 é”™è¯¯å¤„ç†æ”¹è¿›
```go
// å»ºè®®ä½¿ç”¨è‡ªå®šä¹‰é”™è¯¯ç±»å‹
type MirrorNotFoundError struct {
    Name string
}

func (e *MirrorNotFoundError) Error() string {
    return fmt.Sprintf("é•œåƒæº '%s' ä¸å­˜åœ¨", e.Name)
}
```

### 2. ä»£ç é‡æ„

#### 2.1 æå–å…¬å…±çš„åŸå­å†™å…¥å‡½æ•°
```go
// å½“å‰åœ¨ mirror.go, codex.go ä¸­é‡å¤å®ç°
// å»ºè®®æå–åˆ° internal/fileutil.go
func AtomicWriteFile(path string, data []byte, perm os.FileMode) error {
    dir := filepath.Dir(path)
    tmpFile, err := os.CreateTemp(dir, "tmp-*")
    // ...
}
```

#### 2.2 æå–å…¬å…±çš„ç¯å¢ƒå˜é‡è®¾ç½®é€»è¾‘
```go
// codex.go å’Œ env.go ä¸­æœ‰é‡å¤çš„å¹³å°åˆ¤æ–­é€»è¾‘
// å»ºè®®ç»Ÿä¸€åˆ° env.go ä¸­
```

#### 2.3 ä½¿ç”¨ context.Context
- æ·»åŠ è¶…æ—¶å’Œå–æ¶ˆæ”¯æŒï¼Œç‰¹åˆ«æ˜¯åœ¨äº‘åŒæ­¥æ“ä½œä¸­

### 3. æ€§èƒ½ä¼˜åŒ–

#### 3.1 å»¶è¿ŸåŠ è½½é…ç½®
```go
// å½“å‰æ¯æ¬¡å‘½ä»¤éƒ½ä¼šå®Œæ•´åŠ è½½é…ç½®
// å»ºè®®æŒ‰éœ€åŠ è½½
```

#### 3.2 å‡å°‘é‡å¤çš„é…ç½®æ–‡ä»¶è¯»å†™
```go
// switch.go ä¸­å¤šæ¬¡è°ƒç”¨ mm.GetMirrorByName
// å¯ä»¥ç¼“å­˜ç»“æœ
```

---

## å››ã€æµ‹è¯•è¦†ç›–æ”¹è¿›

### 1. ç¼ºå¤±çš„æµ‹è¯•åœºæ™¯

#### 1.1 äº‘åŒæ­¥ç›¸å…³æµ‹è¯•ä¸è¶³
- `sync.go` å’Œ `sync_gist.go` çš„ç½‘ç»œäº¤äº’æµ‹è¯•
- å†²çªè§£å†³é€»è¾‘çš„è¾¹ç•Œæµ‹è¯•

#### 1.2 è·¨å¹³å°è·¯å¾„æµ‹è¯•
- å½“å‰æµ‹è¯•ä¸»è¦åœ¨å•ä¸€å¹³å°è¿è¡Œ
- å»ºè®®æ·»åŠ  mock æ–‡ä»¶ç³»ç»Ÿæµ‹è¯•

#### 1.3 å¹¶å‘å®‰å…¨æµ‹è¯•
- å¤šè¿›ç¨‹åŒæ—¶æ“ä½œé…ç½®æ–‡ä»¶çš„åœºæ™¯

### 2. å»ºè®®æ·»åŠ çš„æµ‹è¯•

```go
// å»ºè®®æ·»åŠ çš„æµ‹è¯•ç”¨ä¾‹
func TestSwitchMirror_InvalidType(t *testing.T) {}
func TestAddMirror_InvalidURL(t *testing.T) {}
func TestVSCodeConfig_AtomicWrite(t *testing.T) {}
func TestEnvManager_WindowsUnset(t *testing.T) {}
func TestSyncConflict_MergeStrategy(t *testing.T) {}
```

---

## äº”ã€æ–‡æ¡£å’Œç”¨æˆ·ä½“éªŒ

### 1. æ–‡æ¡£æ”¹è¿›

#### 1.1 README.md é—®é¢˜
- éƒ¨åˆ†ç¤ºä¾‹ä»£ç ä¸å®é™…å®ç°ä¸åŒ¹é…
- ç¼ºå°‘æ•…éšœæ’é™¤ (Troubleshooting) ç« èŠ‚
- ç¼ºå°‘ API æ–‡æ¡£æˆ– GoDoc æ³¨é‡Š

#### 1.2 ç¼ºå°‘ CHANGELOG.md
- å»ºè®®æ·»åŠ å˜æ›´æ—¥å¿—ï¼Œä½¿ç”¨ Keep a Changelog æ ¼å¼

#### 1.3 ç¼ºå°‘ CONTRIBUTING.md
- ç¼ºå°‘è´¡çŒ®æŒ‡å—

### 2. ç”¨æˆ·ä½“éªŒæ”¹è¿›

#### 2.1 å‘½ä»¤è¾“å‡ºæ ¼å¼åŒ–
```go
// å½“å‰ list å‘½ä»¤è¾“å‡ºå›ºå®šå®½åº¦
// å»ºè®®æ”¯æŒ --output json/yaml/table æ ¼å¼
```

#### 2.2 é”™è¯¯æç¤ºä¿¡æ¯æ”¹è¿›
- æä¾›æ›´å…·ä½“çš„é”™è¯¯åŸå› å’Œè§£å†³å»ºè®®
- æ·»åŠ  `--help` æç¤º

#### 2.3 äº¤äº’å¼æ¨¡å¼
- æ·»åŠ  `codex-mirror add --interactive` å¼•å¯¼å¼æ·»åŠ 

---

## å…­ã€å®‰å…¨æ€§å»ºè®®

### 1. API Key ä¿æŠ¤

#### 1.1 å†…å­˜ä¸­çš„ Key å¤„ç†
```go
// å»ºè®®ä½¿ç”¨å®‰å…¨å­—ç¬¦ä¸²å¤„ç†
// æ“ä½œå®Œæˆåæ¸…é›¶å†…å­˜
defer func() {
    for i := range apiKey {
        apiKey[i] = 0
    }
}()
```

#### 1.2 é…ç½®æ–‡ä»¶æƒé™
```go
// å½“å‰åˆ›å»ºç›®å½•ä½¿ç”¨ 0755
// å»ºè®®é…ç½®æ–‡ä»¶ä½¿ç”¨ 0600
os.WriteFile(path, data, 0600)
```

### 2. äº‘åŒæ­¥å®‰å…¨

#### 2.1 åŠ å¯†å¯†ç å¼ºåº¦éªŒè¯
- å½“å‰åªæ£€æŸ¥é•¿åº¦ >= 8
- å»ºè®®æ·»åŠ å¤æ‚åº¦æ£€æŸ¥

#### 2.2 Token è¿‡æœŸå¤„ç†
- æ·»åŠ  Token æœ‰æ•ˆæ€§æ£€æŸ¥æœºåˆ¶

---

## ä¸ƒã€CI/CD æ”¹è¿›

### 1. GitHub Actions

#### 1.1 æ·»åŠ è‡ªåŠ¨å‘å¸ƒæµç¨‹
```yaml
# å»ºè®®æ·»åŠ  release.yml
on:
  push:
    tags:
      - 'v*'
```

#### 1.2 æ·»åŠ ä¾èµ–æ¼æ´æ‰«æ
```yaml
- name: Run Snyk
  uses: snyk/actions/golang@master
```

### 2. ä»£ç è´¨é‡

#### 2.1 æ·»åŠ  pre-commit hooks
```yaml
# .pre-commit-config.yaml å·²å­˜åœ¨ä½†å¯å¢å¼º
- repo: https://github.com/golangci/golangci-lint
  rev: v1.55.0
  hooks:
    - id: golangci-lint
```

---

## å…«ã€ä¼˜å…ˆçº§å»ºè®®

| ä¼˜å…ˆçº§ | é—®é¢˜/å»ºè®® | å½±å“ |
|--------|----------|------|
| P0 | ä¿®å¤ `codexOnly` æ ‡å¿—æœªä½¿ç”¨ | åŠŸèƒ½å¤±æ•ˆ |
| P0 | VS Code é…ç½®åŸå­å†™å…¥ | æ•°æ®å®‰å…¨ |
| P1 | æ·»åŠ  `update` å‘½ä»¤ | ç”¨æˆ·ä½“éªŒ |
| P1 | ä¿®å¤ Windows ç¯å¢ƒå˜é‡åˆ é™¤ | å¹³å°å…¼å®¹ |
| P1 | URL æ ¼å¼éªŒè¯ | æ•°æ®æœ‰æ•ˆæ€§ |
| P2 | æ·»åŠ  `version` å‘½ä»¤ | è°ƒè¯•æ”¯æŒ |
| P2 | æ·»åŠ  shell è‡ªåŠ¨è¡¥å…¨ | ç”¨æˆ·ä½“éªŒ |
| P2 | ç»Ÿä¸€é”™è¯¯å¤„ç†é£æ ¼ | ä»£ç è´¨é‡ |
| P3 | æµ‹è¯•è¦†ç›–å¢å¼º | ä»£ç è´¨é‡ |
| P3 | æ–‡æ¡£å®Œå–„ | å¯ç»´æŠ¤æ€§ |

---

## ä¹ã€æ€»ç»“

è¯¥é¡¹ç›®æ•´ä½“æ¶æ„æ¸…æ™°ï¼ŒåŠŸèƒ½å®ç°å®Œæ•´ï¼Œä½†å­˜åœ¨ä¸€äº›éœ€è¦ä¿®å¤çš„é—®é¢˜ï¼š

**éœ€è¦ç«‹å³ä¿®å¤**:
1. `--codex-only` æ ‡å¿—é€»è¾‘æœªå®ç°
2. VS Code é…ç½®å†™å…¥ä¸æ˜¯åŸå­æ“ä½œ
3. Windows ç¯å¢ƒå˜é‡åˆ é™¤æ–¹å¼æœ‰è¯¯

**å»ºè®®ä¼˜å…ˆæ·»åŠ **:
1. `update` å‘½ä»¤
2. `version` å‘½ä»¤  
3. URL æ ¼å¼éªŒè¯
4. Shell è‡ªåŠ¨è¡¥å…¨

**ä»£ç è´¨é‡æå‡**:
1. æå–å…¬å…±å‡½æ•°å‡å°‘é‡å¤ä»£ç 
2. ç»Ÿä¸€é”™è¯¯å¤„ç†æ¨¡å¼
3. å¢åŠ æµ‹è¯•è¦†ç›–ç‡
4. å®Œå–„æ–‡æ¡£

name: Build and Release

on:
  push:
    tags: [ 'v*' ]

permissions:
  contents: write
  packages: write

jobs:
  build-cli:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        goos: [linux, windows, darwin]
        goarch: [amd64, arm64]
        exclude:
          # Windows ARM64 支持有限，暂时排除
          - goos: windows
            goarch: arm64

    steps:
    - uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.24'

    - name: Get dependencies
      run: go mod download

    - name: Build CLI binary
      env:
        GOOS: ${{ matrix.goos }}
        GOARCH: ${{ matrix.goarch }}
        VERSION: ${{ github.ref_name }}
        BUILD_TIME: ${{ github.event.head_commit.timestamp }}
        GIT_COMMIT: ${{ github.sha }}
      run: |
        # 设置输出文件名
        if [ "$GOOS" = "windows" ]; then
          OUTPUT_NAME="codex-mirror-cli.exe"
        else
          OUTPUT_NAME="codex-mirror-cli"
        fi

        # 编译 CLI 二进制文件，注入版本信息，使用 cli 构建标签
        go build -tags cli -ldflags="-s -w -X codex-mirror/cmd.Version=${VERSION} -X codex-mirror/cmd.BuildTime=${BUILD_TIME} -X codex-mirror/cmd.GitCommit=${GIT_COMMIT}" -o "$OUTPUT_NAME" main.go

        # 创建发布目录
        mkdir -p release-cli
        mv "$OUTPUT_NAME" release-cli/

    - name: Upload CLI artifacts
      uses: actions/upload-artifact@v4
      with:
        name: codex-mirror-cli-${{ matrix.goos }}-${{ matrix.goarch }}
        path: release-cli/

  build-gui:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: 'ubuntu-latest'
            platform: 'linux'
            arch: 'amd64'
          - os: 'windows-latest'
            platform: 'windows'
            arch: 'amd64'
          - os: 'macos-latest'
            platform: 'darwin'
            arch: 'universal'
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.24'
          cache: true

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Wails CLI
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Install Linux dependencies
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev

      - name: Build Wails GUI (Linux/macOS)
        if: matrix.platform != 'windows'
        run: |
          if [ "${{ matrix.platform }}" = "darwin" ]; then
            wails build -platform darwin/universal
            mkdir -p release-gui
            cp -r build/bin/* release-gui/
          else
            wails build -platform linux/amd64 -tags webkit2_41
            mkdir -p release-gui
            cp build/bin/* release-gui/
          fi

      - name: Build Wails GUI (Windows)
        if: matrix.platform == 'windows'
        shell: pwsh
        run: |
          wails build -platform windows/amd64
          New-Item -ItemType Directory -Path release-gui -Force
          Copy-Item -Path build/bin/* -Destination release-gui/ -Recurse

      - name: Upload GUI artifacts
        uses: actions/upload-artifact@v4
        with:
          name: codex-mirror-gui-${{ matrix.platform }}-${{ matrix.arch }}
          path: release-gui/

  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.24'

    - name: Run tests
      run: go test -v ./...

    - name: Run go vet
      run: go vet ./...

    - name: Run go fmt check
      run: |
        if [ "$(gofmt -s -l . | wc -l)" -gt 0 ]; then
          echo "以下文件需要格式化："
          gofmt -s -l .
          exit 1
        fi

  release:
    needs: [build-cli, build-gui, test]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
    - uses: actions/checkout@v4

    - name: Download all CLI artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts-cli
        pattern: codex-mirror-cli-*

    - name: Download all GUI artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts-gui
        pattern: codex-mirror-gui-*

    - name: Create release archives
      run: |
        mkdir -p release

        # 处理 CLI  artifacts
        cd artifacts-cli
        for dir in */; do
          platform=$(basename "$dir")
          cd "$dir"

          # 根据平台选择压缩格式
          if [[ "$platform" == *"windows"* ]]; then
            zip -r "../../release/${platform}.zip" .
          else
            tar -czf "../../release/${platform}.tar.gz" .
          fi

          cd ..
        done
        cd ..

        # 处理 GUI artifacts
        cd artifacts-gui
        for dir in */; do
          platform=$(basename "$dir")
          cd "$dir"

          # 根据平台选择压缩格式
          if [[ "$platform" == *"windows"* ]]; then
            zip -r "../../release/${platform}.zip" .
          else
            tar -czf "../../release/${platform}.tar.gz" .
          fi

          cd ..
        done
        cd ..

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: release/*
        generate_release_notes: true
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}